@import scala.jdk.CollectionConverters._

@(dashboard: List[java.util.Map[String, Object]])

@main("Dashboard") {

<div class="main">

  <!-- KPI Cards Section -->
  <div class="card kpi-card">
    <h2>üìä Key Metrics</h2>
    <div class="kpi-grid">
      <div class="kpi-item">
        <p>Total Landlords</p>
        <span id="landlordCount">0</span>
      </div>
      <div class="kpi-item">
        <p>Total Tenants</p>
        <span id="tenantCount">0</span>
      </div>
      <div class="kpi-item">
        <p>Total Properties</p>
        <span id="propertyCount">0</span>
      </div>
      <div class="kpi-item">
        <p>Pending Payments</p>
        <span id="pendingPayments">0</span>
      </div>
      <div class="kpi-item">
        <p>Total Collected This Month</p>
        <span id="monthlyCollection">0</span>
      </div>
    </div>
  </div>

  <!-- Recent Activity Section -->
  <div class="card">
    <h2>üìÖ Recent Activity</h2>
    <ul id="recentActivity">
      <li>Loading recent activity...</li>
    </ul>
  </div>

  <!-- Payments Section -->
  <div class="card">
    <h2>üí∞ Recent Payments</h2>
    <ul id="recentPayments">
      <li>Loading payments...</li>
    </ul>
  </div>

  <!-- Map View Section -->
  <div class="card">
    <h2>üó∫Ô∏è Property Map View</h2>
    <div id="propertyMap" style="height:300px; border-radius:1rem;"></div>
  </div>

  <!-- Quick Actions Section -->
  <div class="card">
    <h2>‚ö° Quick Actions</h2>

    <!-- Landlords -->
    <div class="entity-actions">
      <h3>Landlords</h3>
      <button id="addLandlord">‚ûï Add</button>
      <button id="listLandlords">üìã List</button>
    </div>

    <!-- Tenants -->
    <div class="entity-actions">
      <h3>Tenants</h3>
      <button id="addTenant">‚ûï Add</button>
      <button id="listTenants">üìã List</button>
    </div>

    <!-- Properties -->
    <div class="entity-actions">
      <h3>Properties</h3>
      <button id="addProperty">‚ûï Add</button>
      <button id="listProperties">üìã List</button>
    </div>
  </div>

  <!-- System Health Section -->
  <div class="card">
    <h2>üõ°Ô∏è System Status</h2>
    <p id="systemHealth">All systems are running smoothly ‚úÖ</p>
  </div>

</div>

<style>
  .main { display:flex; flex-direction:column; gap:20px; padding:20px; }
  .card { background:white; padding:20px; border-radius:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .kpi-grid { display:flex; flex-wrap:wrap; gap:20px; margin-top:15px; }
  .kpi-item { flex:1; min-width:120px; background:#eef5ff; padding:15px; border-radius:1rem; text-align:center; font-weight:500; }
  .entity-actions { display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap; }
  .entity-actions button { padding:8px 14px; border-radius:6px; border:none; background:linear-gradient(90deg,#007bff,#0056d2); color:white; cursor:pointer; transition:0.3s; }
  .entity-actions button:hover { transform:scale(1.05); }
  #recentActivity, #recentPayments { list-style:none; padding-left:0; }
  #recentActivity li, #recentPayments li { margin-bottom:8px; padding:8px; background:#eef5ff; border-radius:6px; }
  .status-paid { color:green; font-weight:bold; }
  .status-partial { color:orange; font-weight:bold; }
  .status-pending { color:red; font-weight:bold; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA49rije1HuRfuTmuJIfFri8OROqa2FUus"></script>
<script type="text/javascript">
  const DASHBOARD_API_BASE = "http://localhost/rentpulse-api/dashboard";

  // Define credentials ONCE globally
  const appCredentials = {
    app_username: "rentpulse_app_001",
    app_password: "b99marasighan/X"
  };

  // --- Load KPIs ---
  async function loadKPIs() {
    try {
      const res = await fetch(`${DASHBOARD_API_BASE}/dashboard_stats.php`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(appCredentials)
      });
      const data = await res.json();

      if (!data.success) {
        console.error("Dashboard API error:", data.message);
        return;
      }

      document.getElementById("landlordCount").textContent = data.totalLandlords || 0;
      document.getElementById("tenantCount").textContent = data.totalTenants || 0;
      document.getElementById("propertyCount").textContent = data.totalProperties || 0;
      document.getElementById("pendingPayments").textContent = data.pendingPayments || 0;
      document.getElementById("monthlyCollection").textContent = data.monthlyCollection || 0;

    } catch (err) {
      console.error("Failed to fetch KPIs:", err);
    }
  }

  // --- Load Recent Activities ---
  async function loadActivities() {
    try {
      // ‚úÖ Send credentials as payload
      const payload = {
        ...appCredentials,
        request: "activities"
      };

      const res = await fetch(`${DASHBOARD_API_BASE}/get_activities.php`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      const ul = document.getElementById("recentActivity");
      ul.innerHTML = "";

      if (!data.success) {
        ul.innerHTML = `<li>Error: ${data.message}</li>`;
        return;
      }

      if (data.activities && data.activities.length > 0) {
        data.activities.forEach(a => {
          const li = document.createElement("li");
          li.textContent = `${a.date || "-"}: ${a.description || "-"}`;
          ul.appendChild(li);
        });
      } else {
        ul.innerHTML = "<li>No recent activities</li>";
      }
    } catch (err) {
      console.error("Failed to load activities:", err);
      document.getElementById("recentActivity").innerHTML = "<li>Failed to load activities</li>";
    }
  }

  // --- Load Recent Payments ---
  async function loadPayments() {
    try {
      // ‚úÖ Send credentials as payload
      const payload = {
        ...appCredentials,
        request: "payments"
      };

      const res = await fetch(`${DASHBOARD_API_BASE}/get_recent_payments.php`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      const ul = document.getElementById("recentPayments");
      ul.innerHTML = "";

      if (!data.success) {
        ul.innerHTML = `<li>Error: ${data.message}</li>`;
        return;
      }

      if (data.payments && data.payments.length > 0) {
        data.payments.forEach(p => {
          const li = document.createElement("li");
          let statusClass = "";
          let statusIcon = "";

          if (p.status === "paid") {
            statusClass = "status-paid"; statusIcon = "‚úÖ";
          } else if (p.status === "partial") {
            statusClass = "status-partial"; statusIcon = "‚ö†Ô∏è";
          } else {
            statusClass = "status-pending"; statusIcon = "‚ùå";
          }

          li.innerHTML = `${p.date || "-"}: ${p.tenant_name || "Unknown"} - ${p.amount || 0}
            <span class="${statusClass}">${statusIcon} ${p.status}</span>`;
          ul.appendChild(li);
        });
      } else {
        ul.innerHTML = "<li>No recent payments</li>";
      }
    } catch (err) {
      console.error("Failed to load payments:", err);
      document.getElementById("recentPayments").innerHTML = "<li>Failed to load payments</li>";
    }
  }

  // --- Google Maps ---
  async function initMap() {
    const map = new google.maps.Map(document.getElementById("propertyMap"), {
      center: { lat: -1.2921, lng: 36.8219 },
      zoom: 10
    });

    try {
      const res = await fetch(`${DASHBOARD_API_BASE}/total_properties.php`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(appCredentials)
      });
      const data = await res.json();

      if (!data.success || !data.data) return;

      data.data.forEach(p => {
        if (p.lat && p.lng) {
          new google.maps.Marker({
            position: { lat: parseFloat(p.lat), lng: parseFloat(p.lng) },
            map: map,
            title: p.property_name || "Property"
          });
        }
      });
    } catch (err) {
      console.error("Failed to load properties for map:", err);
    }
  }

  // --- Initialize Dashboard ---
  document.addEventListener("DOMContentLoaded", () => {
    loadKPIs();
    loadActivities();
    loadPayments();
    initMap();
  });
</script>
}
